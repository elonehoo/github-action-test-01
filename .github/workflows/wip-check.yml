name: ğŸš¦ Check PR Title

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull request number'
        required: true
  pull_request:
    types: [edited, synchronize]

permissions:
  pull-requests: write
  statuses: write   # å…³é”®ï¼šå…è®¸å†™ commit status

jobs:
  check-title:
    runs-on: ubuntu-latest
    steps:
      - name: Get PR title
        id: get-title
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            let title = "";
            let sha = "";

            if (context.eventName === "workflow_dispatch") {
              // é€šè¿‡è¾“å…¥çš„ PR number è·å– PR æ•°æ®
              const pr_number = context.payload.inputs.pr_number;
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr_number
              });
              title = pr.data.title;
              sha = pr.data.head.sha;
            } else {
              title = context.payload.pull_request.title;
              sha = context.payload.pull_request.head.sha;
            }

            core.setOutput("title", title);
            core.setOutput("sha", sha);

      - name: Report status to PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = "${{ steps.get-title.outputs.title }}";
            const sha = "${{ steps.get-title.outputs.sha }}";

            const state = title.startsWith("[WIP]") ? "failure" : "success";
            const description = state === "failure"
              ? "âŒ PR æ ‡é¢˜åŒ…å« [WIP]ï¼Œç¦æ­¢åˆå¹¶"
              : "âœ… æ ‡é¢˜åˆæ³•ï¼Œå¯ä»¥åˆå¹¶";

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: sha,
              state: state,
              context: "PR Title Check",
              description: description
            });

            console.log(`Title: ${title}`);
            console.log(`Status: ${state}`);
